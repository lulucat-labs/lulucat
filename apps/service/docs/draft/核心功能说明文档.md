# LuluCat Server - 核心功能说明文档

## 项目概述

LuluCat Server 是一个基于 NestJS 的综合性自动化任务执行平台，专门设计用于 Web3/DeFi 生态系统中的多账户批量操作和管理。该系统通过智能化的任务引擎，实现了对区块链项目交互、社交媒体授权、钱包操作等复杂场景的自动化处理。

## 核心功能模块

### 1. 任务执行引擎 (Task Engine)

**功能描述：** 系统的核心模块，负责任务的调度、执行和管理。

**核心特性：**
- **多线程并发执行**：支持可配置的并发线程数，提高执行效率
- **队列管理**：使用 better-queue 实现任务队列，支持失败重试和进度跟踪
- **浏览器上下文隔离**：为每个任务创建独立的浏览器环境，确保账户间隔离
- **实时日志记录**：详细记录任务执行过程和结果
- **异常处理**：统一的异常分类和处理机制

**关键组件：**
- `TaskEngineService`: 任务引擎核心服务
- `TaskQueueService`: 任务队列管理
- `TaskWorkerService`: 任务执行工作器
- `BrowserContextService`: 浏览器上下文管理

### 2. 账户管理系统

**功能描述：** 提供统一的多类型账户管理和资源分配功能。

**支持的账户类型：**

#### 2.1 EVM 钱包管理
- **私钥加密存储**：使用 AES 加密算法保护私钥安全
- **自动余额查询**：实时获取钱包余额信息
- **多链支持**：支持以太坊、Arbitrum、Polygon 等 EVM 兼容链

#### 2.2 社交媒体账户
- **Discord 账户**：支持 token 认证和自动授权
- **Twitter/X 账户**：管理 Twitter 账户和 API 访问
- **邮箱账户**：集成邮箱服务，支持验证码获取

#### 2.3 基础设施资源
- **代理 IP 管理**：
  - 支持 HTTP/SOCKS5 代理
  - 地理位置信息记录
  - IP 状态监控和健康检查
- **浏览器指纹管理**：
  - UserAgent 定制
  - WebGL 指纹配置
  - 设备特征模拟

#### 2.4 账户组织结构
- **账户组 (Account Groups)**：将相关账户组织成组
- **账户项 (Account Group Items)**：组内的具体账户配置
- **资源关联**：每个账户项可关联钱包、社交账户、代理IP、浏览器指纹

### 3. 脚本系统和 TDK (Task Development Kit)

**功能描述：** 提供标准化的任务脚本开发框架和工具库。

#### 3.1 TDK 工具库

**浏览器操作工具 (browser/)**
- `wait-for-page-load.ts`: 智能页面加载等待
- `is-element-visible.ts`: 元素可见性检测
- `retry.ts`: 操作重试机制

**DeFi 操作工具 (defi/)**
- `binance-to-wallet.ts`: 币安交易所提币操作
- `bridge-chain.ts`: 跨链桥接操作
- `evm-transfer.ts`: EVM 转账操作
- `get-currency-chain.ts`: 获取币种链信息

**钱包操作工具 (wallet/)**
- `launch-okx-wallet.ts`: OKX 钱包插件操作
- `get-eth-balance.ts`: ETH 余额查询

**社交媒体工具 (social-media/)**
- `auto-login-discord.ts`: Discord 自动登录
- `auto-login-x.ts`: X/Twitter 自动登录

#### 3.2 项目特定脚本

**ABS 项目脚本 (abs/)**
- `auth-discord.ts`: ABS 平台 Discord 授权
- `auth-x.ts`: ABS 平台 X 授权
- `binance-to-wallet.ts`: 币安到钱包转账
- `bridge-task.ts`: 跨链桥接任务
- `claim-badges.ts`: 徽章领取

**Somnia 项目脚本 (somnia/)**
- 官方网络和测试网络的各种交互脚本
- 包含连接、授权、签到等功能

**Stork 项目脚本 (stork/)**
- 邮箱验证码获取
- 密码重置操作

### 4. 任务结果管理

**功能描述：** 统一管理和存储任务执行结果。

**核心特性：**
- **JSON 数据存储**：灵活的结构化数据存储
- **任务状态跟踪**：记录各个子任务的完成状态
- **结果查询**：支持条件查询和统计分析
- **数据加密**：敏感数据自动加密存储

### 5. 项目和脚本管理

**功能描述：** 管理不同的区块链项目和相关执行脚本。

**核心组件：**
- **项目管理**：创建和管理不同的区块链项目
- **脚本管理**：管理可执行的自动化脚本
- **任务配置**：关联项目、脚本和账户组

### 6. 日志和监控系统

**功能描述：** 全面的日志记录和系统监控。

**特性：**
- **分级日志**：支持 debug、info、warn、error 等级别
- **日志轮转**：按日期自动轮转日志文件
- **实时监控**：任务执行状态实时更新
- **异常追踪**：详细的错误堆栈和上下文信息

## 核心工作流程

### 1. 任务执行流程

```
1. 用户创建任务并选择账户组
2. TaskEngineService 解析任务配置
3. 为每个账户项创建任务上下文
4. TaskQueueService 添加任务到队列
5. TaskWorkerService 执行具体脚本
6. BrowserContextService 创建隔离的浏览器环境
7. 脚本执行具体的自动化操作
8. 结果记录到 TaskResult
9. 日志更新和状态同步
```

### 2. 浏览器自动化流程

```
1. 创建带有代理和指纹的浏览器上下文
2. 加载必要的浏览器扩展（如 OKX 钱包）
3. 导入私钥到钱包扩展
4. 执行项目特定的交互脚本
5. 处理各种异常情况
6. 清理资源和关闭浏览器
```

### 3. 账户资源分配流程

```
1. 从账户组获取可用账户项
2. 为每个账户项分配：
   - EVM 钱包（含私钥）
   - 社交媒体账户
   - 代理 IP
   - 浏览器指纹
3. 创建隔离的执行环境
4. 执行完成后释放资源
```

## 安全特性

### 1. 数据加密
- **私钥加密**：所有私钥使用 AES 加密存储
- **配置加密**：敏感配置信息加密保护
- **传输安全**：HTTPS 和 WSS 加密传输

### 2. 访问控制
- **JWT 认证**：基于 JWT 的用户认证
- **权限隔离**：用户数据严格隔离
- **资源保护**：防止跨用户资源访问

### 3. 环境隔离
- **浏览器上下文隔离**：每个任务独立的浏览器环境
- **代理隔离**：不同账户使用不同的代理 IP
- **指纹隔离**：独特的浏览器指纹配置

## 扩展性设计

### 1. 模块化架构
- **插件式脚本**：新项目脚本可独立开发和部署
- **TDK 工具库**：可复用的通用工具和函数
- **标准化接口**：统一的脚本执行接口

### 2. 配置化管理
- **环境配置**：支持开发、测试、生产多环境
- **参数化脚本**：脚本行为可通过参数配置
- **动态加载**：运行时动态加载脚本模块

### 3. 性能优化
- **并发控制**：可配置的并发线程数
- **资源缓存**：浏览器上下文和扩展缓存
- **队列优化**：智能的任务队列调度

## 典型应用场景

### 1. 区块链项目交互
- **测试网络参与**：自动参与各种测试网络活动
- **空投任务**：批量完成空投任务要求
- **DeFi 操作**：自动化的 DeFi 协议交互

### 2. 社交媒体管理
- **授权管理**：批量完成社交媒体授权
- **活动参与**：自动参与项目活动和投票
- **内容交互**：自动化的点赞、转发等操作

### 3. 资产管理
- **批量转账**：多账户间的资产转移
- **跨链操作**：自动化的跨链桥接
- **余额监控**：实时监控账户余额变化

## 技术特点总结

1. **高度自动化**：减少人工干预，提高操作效率
2. **安全可靠**：多层次的安全保护机制
3. **可扩展性强**：模块化设计，易于扩展新功能
4. **用户友好**：直观的 API 接口和管理界面
5. **监控完善**：全面的日志记录和状态监控
6. **资源高效**：智能的资源分配和管理
7. **异常健壮**：完善的异常处理和恢复机制

该系统为 Web3 生态系统中的批量操作和自动化管理提供了一个强大、安全、可靠的解决方案。